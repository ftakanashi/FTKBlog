{% extends 'original/base.html' %}
{% load static %}

{% block title %}
    人体生物节律查询
{% endblock %}

{% block style %}
    <link href="{% static 'comp/datetimepicker/css/bootstrap-datetimepicker.min.css' %}" rel="stylesheet" />
    <style>
    .main-panel{
        padding: 20px;
    }
    #graph{
        width: 100%;
        height: 350px;
        margin-bottom: 20px;
    }
    </style>
{% endblock %}

{% block toolsbar %}{% endblock %}
{% block left_page_content %}{% endblock %}
{% block main_ground %}
<div class="main-panel">
    <div class="row">
        <div class="col-lg-1 col-md-1"></div>
        <div class="col-lg-10 col-md-10 col-sm-12 col-xs-12">
            <div id="graph"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-2 col-md-2"></div>
        <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
            <div class="input-group date">
                <input type="text" class="form-control" id="startInput" placeholder="出生日期" />
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
        </div>
        <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
            <div class="input-group date">
                <input type="text" class="form-control" id="endInput" placeholder="测试日期" />
                <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                </span>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-lg-2 col-md-2"></div>
        <div class="col-lg-10 col-md-10 col-sm-12 col-xs-12">
            <button type="button" class="btn btn-success" id="submit">
                <i class="fa fa-search"></i>查询
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
    <script src="{% static 'comp/datetimepicker/js/bootstrap-datetimepicker.min.js' %}"></script>
    <script src="{% static 'comp/datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js' %}"></script>
    <script src="{% static 'comp/moment.js' %}"></script>
    <script src="{% static 'comp/echarts/echarts-all.js' %}"></script>
    <script>
    $(document).ready(function(){
        // 构建datetimepicker
        $('#startInput').datetimepicker({
            format: 'yyyy-mm-dd',
            language: 'zh-CN',
            todayBtn: 'linked',
            maxView: 4,
            minView: 2,
            startView: 4,
            autoClose: true,
            initialDate: '2000-01-01',
            pickerPosition: 'bottom-right'
        });
        $('#endInput').datetimepicker({
            format: 'yyyy-mm-dd',
            language: 'zh-CN',
            todayBtn: 'linked',
            maxView: 4,
            minView: 2,
            startView: 4,
            autoClose: true,
            pickerPosition: 'bottom-right'
        });

        // 初始化图表
        var chart = echarts.init($('#graph')[0]);
        function getDefaultOption(){
            var option = {
                backgroundColor: '#f4f4f4',
                title : {
                    text: '人体生物节律',
                    subtext: '认真你就输了',
                    zlevel: -1,
                    textStyle: {fontSize: 30},
                    x: 'center'
                },
                tooltip : {
                    trigger: 'axis'
                },
                legend: {
                    data:['体力指数','情绪指数','智力指数'],
                    itemGap: 20,
                    textStyle: {fontSize: 20},
                    y: 'bottom'
                },
                toolbox: {
                    show : true,
                    feature : {
                        saveAsImage : {show: true}
                    }
                },
                calculable : true,
                xAxis : [
                    {
                        type : 'category',
                        boundaryGap : false,
                        data : [],
                        axisLine: {
                            lineStyle: {color: 'darkgray'}
                        }
                    }
                ],
                yAxis : [
                    {
                        type : 'value',
                        axisLine: {
                            lineStyle: {color: 'darkgray'}
                        }
                    }
                ],
                series : [
                    {
                        name:'体力指数',
                        type:'line',
                        itemStyle: {
                            normal:{
                                lineStyle: {color: '#76933c'}
                            }
                        },
                        data:[],
                        markPoint: {
                            symbolSize: 15,
                            data: []
                        }
                    },
                    {
                        name:'情绪指数',
                        type:'line',
                        itemStyle: {
                            normal: {color: '#963634'}
                        },
                        data:[],
                        markPoint: {
                            symbolSize: 15,
                            data: []
                        }
                    },
                    {
                        name: '智力指数',
                        type: 'line',
                        itemStyle: {
                            normal: {color: '#366092'}
                        },
                        data: [],
                        markPoint: {
                            symbolSize: 15,
                            data: []
                        }
                    }
                ]
            };
            return option;
        }

        // 生物钟计算函数
        function biologyRhythm(startDate, endDate){
            var period = endDate.diff(startDate, 'days');
            var xStart = period - 15;
            var xEnd = period + 15;
            var t = [], q = [], z = [];
            var _t, _q, _z;
            var et, eq, ez;
            for (var d=xStart;d<=xEnd;d++){
                _t = 10 * Math.sin(Math.PI / 11.5 * d).toFixed(2);
                _q = 10 * Math.sin(Math.PI / 14 * d).toFixed(2);
                _z = 10 * Math.sin(Math.PI / 16.5 * d).toFixed(2);
                t.push(_t);    // 体力
                q.push(_q);      // 情绪
                z.push(_z);    // 智力
                if (d == period){
                    et = _t;
                    eq = _q;
                    ez = _z;
                }
            }

            var xStr = [];
            var dStr = endDate.format('YYYY-MM-DD');
            for (var i=-15;i<=15;i++){
                xStr.push(moment(dStr).add(i,'days').format('YYYY-MM-DD'));
            }
            option = getDefaultOption();
            option.xAxis[0].data = xStr;
            option.series[0].data = t;
            option.series[0].markPoint.data = [{name: dStr, value: et, xAxis: dStr, yAxis: et}];
            option.series[1].data = q;
            option.series[1].markPoint.data = [{name: dStr, value: eq, xAxis: dStr, yAxis: eq}];
            option.series[2].data = z;
            option.series[2].markPoint.data = [{name: dStr, value: ez, xAxis: dStr, yAxis: ez}];
            chart.setOption(option);
        }

        $('#submit').click(function(event){
            var startDate = $('#startInput').val();
            var endDate = $('#endInput').val();
            if (startDate == '' || endDate == ''){
                layer.msg('请选择出生日期和测试日期');
                return;
            }
            startDate = moment(startDate);
            endDate = moment(endDate);
            if (startDate >= endDate){
                layer.msg('请输入合法的日期');
                return;
            }
            biologyRhythm(startDate, endDate);
        });
    });
    </script>
{% endblock %}

{% block footer %}{% endblock %}